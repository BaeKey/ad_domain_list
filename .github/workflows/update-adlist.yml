name: Update AdBlock List

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Process Domain Lists
        run: |
          python - <<EOF
          import requests
          import os

          # ================= é…ç½®åŒºåŸŸ =================
          AD_LIST_URL = "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/master/anti-ad-domains.txt"

          REMOTE_WHITELISTS = [
              "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/refs/heads/master/discretion/dns.txt",
              "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/refs/heads/master/discretion/anv.txt"
          ]

          HAGEZI_LIST_URL = "https://raw.githubusercontent.com/hagezi/dns-blocklists/refs/heads/main/domains/ultimate.txt"

          LOCAL_WHITELIST_FILE = "whitelist.txt"
          OUTPUT_FILE = "clean-list.txt"
          # ===========================================

          def download_text(url):
              try:
                  print(f"Downloading: {url}")
                  resp = requests.get(url, timeout=30)
                  resp.raise_for_status()
                  return resp.text
              except Exception as e:
                  print(f"Error downloading {url}: {e}")
                  return ""

          def parse_lines(text):
              lines = set()
              for line in text.splitlines():
                  line = line.strip()
                  if not line or line.startswith("#"):
                      continue
                  lines.add(line)
              return lines

          def get_base_domain(domain):
              """æå–ä¸»åŸŸåï¼Œå¤„ç† .com.cn ç­‰ç‰¹æ®Šæƒ…å†µ"""
              parts = domain.split('.')
              if len(parts) < 2:
                  return domain
              if len(parts) >= 3 and parts[-2] in ['com', 'net', 'org', 'gov', 'edu', 'co', 'ac'] and parts[-1] in ['cn', 'uk', 'hk', 'tw', 'jp', 'kr']:
                  return ".".join(parts[-3:])
              return ".".join(parts[-2:])

          def is_whitelisted(domain, rules):
              """æ£€æŸ¥åŸŸåæ˜¯å¦åœ¨ç™½åå•è§„åˆ™ä¸­"""
              if not rules:
                  return False
              # ä¼˜åŒ–æ€§èƒ½ï¼šå¦‚æœè§„åˆ™å¾ˆå°‘ï¼Œå¯ä»¥ç”¨ anyï¼›å¦‚æœè§„åˆ™å¾ˆå¤šï¼Œå»ºè®®ä¼˜åŒ–ç®—æ³•ã€‚
              # è¿™é‡Œä¿æŒåŸæœ‰çš„åç¼€åŒ¹é…é€»è¾‘
              return any(domain == r or domain.endswith("." + r) for r in rules)

          def main():
              # --- 1. anti-AD ä¸»åˆ—è¡¨ ---
              ad_text = download_text(AD_LIST_URL)
              ad_domains = parse_lines(ad_text)
              original_count = len(ad_domains)
              print(f"åŸå§‹å¹¿å‘ŠåŸŸåæ•°é‡: {original_count}")

              # --- 2. è¿œç¨‹ç™½åå•ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰ ---
              remote_wl_domains = set()
              for url in REMOTE_WHITELISTS:
                  remote_wl_domains.update(parse_lines(download_text(url)))

              before_remote = len(ad_domains)
              ad_domains -= remote_wl_domains
              removed_by_remote = before_remote - len(ad_domains)
              print(f"è¿œç¨‹ç™½åå•ç§»é™¤æ•°é‡: {removed_by_remote}")

              # --- 3. æœ¬åœ°ç™½åå•ï¼ˆå‡†å¤‡è§„åˆ™ï¼‰ ---
              user_rules = set()
              if os.path.exists(LOCAL_WHITELIST_FILE):
                  with open(LOCAL_WHITELIST_FILE, "r", encoding="utf-8") as f:
                      user_rules = parse_lines(f.read())

              # è¿‡æ»¤ anti-AD
              removed_by_user = 0
              if user_rules:
                  filtered = []
                  for domain in ad_domains:
                      if is_whitelisted(domain, user_rules):
                          removed_by_user += 1
                      else:
                          filtered.append(domain)
                  ad_domains = set(filtered)

              print(f"ç”¨æˆ·ç™½åå•ç§»é™¤æ•°é‡: {removed_by_user}")

              # --- 4. Hagezi åˆ—è¡¨ä¸åŒå‘æ•‘æ´é€»è¾‘ ---
              hagezi_domains = parse_lines(download_text(HAGEZI_LIST_URL))
              print(f"Hagezi åŸå§‹æ•°é‡: {len(hagezi_domains)}")
              
              # A. è®¡ç®—ä¸¥æ ¼äº¤é›† (Strict Intersection)
              intersection_domains = ad_domains & hagezi_domains
              print(f"ä¸¥æ ¼äº¤é›†æ•°é‡: {len(intersection_domains)}")

              # B. æå–äº¤é›†ä¸­çš„â€œæ´»è·ƒä¸»åŸŸåå®¶æ—â€ (Active Roots)
              active_roots = set()
              for d in intersection_domains:
                  active_roots.add(get_base_domain(d))
              print(f"æ´»è·ƒä¸»åŸŸåå®¶æ—æ•°: {len(active_roots)}")

              # C. åŒå‘æ•‘æ´ (Bi-directional Rescue)
              # ç›®æ ‡ï¼šæ‰¾å‡º (Anti-AD å¹¶é›† Hagezi) ä¸­ï¼Œæ‰€æœ‰ä¸»åŸŸåå±äº active_roots çš„åŸŸå
              
              # æ•‘æ´æ¥æº 1: Anti-AD ä¸­è¢«ä¸¢å¼ƒçš„éƒ¨åˆ† (ad_domains - intersection)
              # æ³¨æ„ï¼šad_domains å·²ç»åœ¨å‰é¢ç»è¿‡äº†ç™½åå•è¿‡æ»¤ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç”¨
              candidates_ad = ad_domains - intersection_domains
              rescued_from_ad = set()
              for d in candidates_ad:
                  if get_base_domain(d) in active_roots:
                      rescued_from_ad.add(d)
              
              # æ•‘æ´æ¥æº 2: Hagezi ä¸­è¢«ä¸¢å¼ƒçš„éƒ¨åˆ† (hagezi - intersection)
              # æ³¨æ„ï¼šHagezi æ˜¯åŸå§‹åˆ—è¡¨ï¼Œæ•‘æ´å›æ¥å‰å¿…é¡»è¿‡ä¸€éç™½åå•ï¼
              candidates_hagezi = hagezi_domains - intersection_domains
              rescued_from_hagezi = set()
              for d in candidates_hagezi:
                  if get_base_domain(d) in active_roots:
                      # å…³é”®ï¼šæ£€æŸ¥æ˜¯å¦è¯¯æ€ç™½åå•
                      if not is_whitelisted(d, user_rules):
                          rescued_from_hagezi.add(d)
              
              # D. åˆå¹¶æœ€ç»ˆç»“æœ
              final_domains = intersection_domains | rescued_from_ad | rescued_from_hagezi
              
              count_rescued_ad = len(rescued_from_ad)
              count_rescued_hagezi = len(rescued_from_hagezi)
              
              # è®¡ç®—è¢«é€»è¾‘è¿‡æ»¤æ‰çš„æ€»æ•° (Anti-AD å‰©ä½™æ€»æ•° - æœ€ç»ˆç»“æœä¸­æ¥è‡ª Anti-AD çš„éƒ¨åˆ†)
              # è¿™æ˜¯ä¸€ä¸ªç²—ç•¥ç»Ÿè®¡ï¼Œä¸ºäº†æŠ¥è¡¨å¥½çœ‹
              kept_from_ad = intersection_domains | rescued_from_ad
              removed_by_logic = len(ad_domains) - len(kept_from_ad)

              print(f"ä» Anti-AD æ•‘æ´: {count_rescued_ad}")
              print(f"ä» Hagezi æ•‘æ´: {count_rescued_hagezi}")

              # --- 5. GitHub Summary ---
              final_count = len(final_domains)
              summary = os.environ.get("GITHUB_STEP_SUMMARY")
              if summary:
                  with open(summary, "a", encoding="utf-8") as f:
                      f.write("### ğŸ›¡ï¸ å¹¿å‘Šè¿‡æ»¤ç»Ÿè®¡æŠ¥å‘Š\n")
                      f.write("| é¡¹ç›® | æ•°é‡ |\n")
                      f.write("| :--- | :--- |\n")
                      f.write(f"| ğŸ“¥ anti-AD åŸå§‹ | **{original_count}** |\n")
                      f.write(f"| ğŸŒ è¿œç¨‹ç™½åå• | -{removed_by_remote} |\n")
                      f.write(f"| ğŸ‘¤ æœ¬åœ°ç™½åå• | -{removed_by_user} |\n")
                      f.write(f"| ğŸ”— ä¸¥æ ¼äº¤é›† | {len(intersection_domains)} |\n")
                      f.write(f"| ğŸš‘ **Anti-AD æ•‘æ´** | **+{count_rescued_ad}** |\n")
                      f.write(f"| ğŸš‘ **Hagezi æ•‘æ´** | **+{count_rescued_hagezi}** |\n")
                      f.write(f"| âœ… **æœ€ç»ˆæ•°é‡** | **{final_count}** |\n")

              # --- 6. å†™å…¥æœ€ç»ˆæ–‡ä»¶ ---
              with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                  for domain in sorted(final_domains):
                      f.write(domain + "\n")

              print(f"å®Œæˆï¼Œè¾“å‡ºè‡³ {OUTPUT_FILE}")

          if __name__ == "__main__":
              main()
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add clean-list.txt
          git diff --quiet && git diff --staged --quiet || (
            git commit -m "Update clean adblock list" &&
            git push
          )
