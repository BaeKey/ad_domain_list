name: Update AdBlock List

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Process Domain Lists
        run: |
          python - <<EOF
          import requests
          import os

          # ================= é…ç½®åŒºåŸŸ =================
          AD_LIST_URL = "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/master/anti-ad-domains.txt"
          
          REMOTE_WHITELISTS = [
              "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/refs/heads/master/discretion/dns.txt",
              "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/refs/heads/master/discretion/anv.txt"
          ]
          
          LOCAL_WHITELIST_FILE = "whitelist.txt"
          OUTPUT_FILE = "clean-list.txt"
          # ===========================================

          def download_text(url):
              try:
                  print(f"Downloading: {url}...")
                  resp = requests.get(url, timeout=30)
                  resp.raise_for_status()
                  return resp.text
              except Exception as e:
                  print(f"Error downloading {url}: {e}")
                  return ""

          def parse_lines(text):
              lines = set()
              for line in text.splitlines():
                  line = line.strip()
                  if not line or line.startswith("#"):
                      continue
                  lines.add(line)
              return lines

          def main():
              # --- 1. èŽ·å–åŽŸå§‹åˆ—è¡¨ ---
              ad_text = download_text(AD_LIST_URL)
              ad_domains = parse_lines(ad_text)
              original_count = len(ad_domains)
              print(f"åŽŸå§‹å¹¿å‘ŠåŸŸåæ•°é‡: {original_count}")

              # --- 2. è¿œç¨‹ç™½åå•å¤„ç† (å…¨é‡/ç²¾ç¡®åŒ¹é…) ---
              remote_wl_domains = set()
              for url in REMOTE_WHITELISTS:
                  content = download_text(url)
                  remote_wl_domains.update(parse_lines(content))
              
              # è®¡ç®—ä¹‹å‰çš„æ•°é‡
              count_before_remote = len(ad_domains)
              # æ‰§è¡Œå·®é›†è¿ç®—
              ad_domains = ad_domains - remote_wl_domains
              # è®¡ç®—ç§»é™¤çš„æ•°é‡
              removed_by_remote = count_before_remote - len(ad_domains)
              print(f"è¿œç¨‹ç™½åå•ç§»é™¤æ•°é‡: {removed_by_remote}")

              # --- 3. æœ¬åœ°ç™½åå•å¤„ç† (æ³›åŸŸå/å­åŸŸååŒ¹é…) ---
              user_rules = set()
              if os.path.exists(LOCAL_WHITELIST_FILE):
                  with open(LOCAL_WHITELIST_FILE, 'r', encoding='utf-8') as f:
                      user_rules = parse_lines(f.read())
              
              removed_by_user = 0
              if user_rules:
                  final_domains = []
                  for domain in ad_domains:
                      should_remove = False
                      for rule in user_rules:
                          # åªè¦æ˜¯ rule æœ¬èº«ï¼Œæˆ–è€…æ˜¯ rule çš„å­åŸŸåï¼Œéƒ½åŽ»é™¤
                          if domain == rule or domain.endswith("." + rule):
                              should_remove = True
                              break
                      
                      if should_remove:
                          removed_by_user += 1
                      else:
                          final_domains.append(domain)
                  
                  # æ›´æ–° ad_domains ä¸ºè¿‡æ»¤åŽçš„åˆ—è¡¨
                  ad_domains = set(final_domains)
              
              print(f"ç”¨æˆ·ç™½åå•ç§»é™¤æ•°é‡: {removed_by_user}")

              # --- 4. ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Šåˆ° GitHub Summary ---
              # è¿™ä¼šè®©ç»Ÿè®¡ä¿¡æ¯ç›´æŽ¥æ˜¾ç¤ºåœ¨ Action çš„æ‘˜è¦é¡µé¢ï¼Œéžå¸¸ç›´è§‚
              final_count = len(ad_domains)
              summary_file = os.environ.get('GITHUB_STEP_SUMMARY')
              if summary_file:
                  with open(summary_file, 'a', encoding='utf-8') as f:
                      f.write("### ðŸ›¡ï¸ å¹¿å‘Šè¿‡æ»¤ç»Ÿè®¡æŠ¥å‘Š\n")
                      f.write("| ç»Ÿè®¡é¡¹ | æ•°é‡ |\n")
                      f.write("| :--- | :--- |\n")
                      f.write(f"| ðŸ“¥ åŽŸå§‹åˆ—è¡¨æ€»æ•° | **{original_count}** |\n")
                      f.write(f"| ðŸŒ è¿œç¨‹ç™½åå•ç§»é™¤ (ç²¾ç¡®åŒ¹é…) | -{removed_by_remote} |\n")
                      f.write(f"| ðŸ‘¤ ç”¨æˆ·ç™½åå•ç§»é™¤ (åŒ…å«å­åŸŸå) | -{removed_by_user} |\n")
                      f.write(f"| âœ… **æœ€ç»ˆå‰©ä½™æ•°é‡** | **{final_count}** |\n")

              # --- 5. å†™å…¥æ–‡ä»¶ (çº¯å‡€ç‰ˆï¼Œæ— å¤´éƒ¨ä¿¡æ¯) ---
              with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                  # ç›´æŽ¥æŽ’åºå†™å…¥ï¼Œä¸å†™ä»»ä½• Header
                  for domain in sorted(list(ad_domains)):
                      f.write(domain + "\n")
              
              print(f"Done. Saved to {OUTPUT_FILE}")

          if __name__ == "__main__":
              main()
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add clean-list.txt
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update list: -${{ env.REMOVED_COUNT }} domains" && git push)